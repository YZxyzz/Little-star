# 数据安全架构设计

> ⚠️ **架构更新 (2025-02-05)**：针对长录音场景的隐私安全需求，引入P0-P3隐私分级架构和TEE可信执行环境设计。

## 一、安全架构概述

### 1.1 安全设计原则

1. **Defense in Depth（纵深防御）**：多层安全防护
2. **Zero Trust（零信任）**：默认不信任，始终验证
3. **Least Privilege（最小权限）**：仅授予必要权限
4. **Secure by Default（默认安全）**：安全配置为默认选项
5. **Privacy by Design（隐私设计）**：隐私保护融入架构设计
6. **Data Minimization（数据最小化）**：仅收集和处理必要数据

### 1.2 安全架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                        安全架构总览                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     边界安全层                               │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │   │
│  │  │  WAF    │  │  DDoS   │  │ API网关  │  │  CDN    │        │   │
│  │  │ 防护    │  │ 防护    │  │ 认证    │  │ 安全    │        │   │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘        │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              │                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     应用安全层                               │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │   │
│  │  │ 身份    │  │ 访问    │  │ 输入    │  │ 会话    │        │   │
│  │  │ 认证    │  │ 控制    │  │ 验证    │  │ 管理    │        │   │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘        │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              │                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     数据安全层                               │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │   │
│  │  │ 传输    │  │ 存储    │  │ 密钥    │  │ 数据    │        │   │
│  │  │ 加密    │  │ 加密    │  │ 管理    │  │ 脱敏    │        │   │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘        │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              │                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     基础设施安全层                           │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │   │
│  │  │ 网络    │  │ 服务器  │  │ 容器    │  │ 数据库  │        │   │
│  │  │ 隔离    │  │ 加固    │  │ 安全    │  │ 安全    │        │   │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘        │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              │                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     安全运营层                               │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │   │
│  │  │ 日志    │  │ 监控    │  │ 告警    │  │ 应急    │        │   │
│  │  │ 审计    │  │ 检测    │  │ 响应    │  │ 处置    │        │   │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘        │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 二、身份认证与访问控制

### 2.1 用户认证

| 认证方式 | 场景 | 安全级别 |
|---------|------|---------|
| 手机号+验证码 | 登录、敏感操作 | 高 |
| 微信授权 | 快捷登录 | 中 |
| JWT Token | API访问 | 中 |
| Refresh Token | Token续期 | 高 |

### 2.2 Token设计

```python
# JWT Token 结构
{
    "header": {
        "alg": "RS256",
        "typ": "JWT"
    },
    "payload": {
        "sub": "user_id",          # 用户ID
        "iat": 1705320000,         # 签发时间
        "exp": 1705406400,         # 过期时间（24小时）
        "jti": "unique_token_id",  # Token ID（用于黑名单）
        "scope": ["user"],         # 权限范围
        "device_id": "xxx"         # 设备ID
    },
    "signature": "..."
}

# Refresh Token
{
    "token": "random_256bit_string",
    "user_id": "xxx",
    "device_id": "xxx",
    "expires_at": "30 days",
    "created_at": "timestamp"
}
```

### 2.3 访问控制模型

```
┌─────────────────────────────────────────────────────────────┐
│                    RBAC + ABAC 混合模型                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  角色（Role）                                               │
│  ├── owner（孩子档案创建者）                                 │
│  │   └── 完全控制权                                         │
│  ├── parent（父母）                                         │
│  │   └── 读写权限                                           │
│  ├── grandparent（祖父母）                                  │
│  │   └── 只读权限（可配置）                                  │
│  └── viewer（其他查看者）                                   │
│      └── 受限只读                                           │
│                                                             │
│  属性（Attribute）                                          │
│  ├── 资源所有权：只能访问自己家庭的数据                       │
│  ├── 时间限制：敏感操作需要近期验证                          │
│  └── 设备绑定：关键操作限制在已绑定设备                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.4 权限矩阵

| 操作 | Owner | Parent | Grandparent | Viewer |
|------|-------|--------|-------------|--------|
| 查看报告 | ✓ | ✓ | ✓ | ✓ |
| 添加记录 | ✓ | ✓ | ✓ | ✗ |
| 删除记录 | ✓ | ✓ | ✗ | ✗ |
| 编辑孩子档案 | ✓ | ✓ | ✗ | ✗ |
| 管理家庭成员 | ✓ | ✗ | ✗ | ✗ |
| 删除孩子档案 | ✓ | ✗ | ✗ | ✗ |
| 导出数据 | ✓ | ✓ | ✗ | ✗ |

---

## 三、数据加密方案

### 3.1 传输加密

| 场景 | 加密方式 | 配置 |
|------|---------|------|
| HTTPS | TLS 1.3 | 强制启用，禁用低版本 |
| WebSocket | WSS | TLS加密 |
| 文件上传 | HTTPS + 预签名URL | 直传OSS |

### 3.2 存储加密

| 数据类型 | 加密方式 | 密钥管理 |
|---------|---------|---------|
| 数据库 | AES-256-GCM | 阿里云KMS |
| 文件存储 | SSE-KMS | 阿里云KMS |
| 本地存储（APP） | AES-256 | Keychain/Keystore |
| 敏感字段 | 应用层加密 | 用户级密钥 |

### 3.3 敏感字段加密

```python
# 敏感字段列表
SENSITIVE_FIELDS = [
    'phone',           # 手机号
    'child_name',      # 孩子真实姓名
    'birth_date',      # 出生日期
    'audio_content',   # 音频转写内容（可选）
]

# 加密流程
def encrypt_sensitive_field(plaintext: str, user_id: str) -> str:
    """
    使用用户级密钥加密敏感字段
    """
    # 1. 从KMS获取用户数据密钥
    data_key = kms.get_user_data_key(user_id)
    
    # 2. AES-256-GCM加密
    cipher = AES.new(data_key, AES.MODE_GCM)
    ciphertext, tag = cipher.encrypt_and_digest(plaintext.encode())
    
    # 3. 返回 nonce + tag + ciphertext 的Base64编码
    return base64.b64encode(cipher.nonce + tag + ciphertext).decode()
```

### 3.4 密钥管理架构

```
┌─────────────────────────────────────────────────────────────┐
│                    密钥层级结构                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              主密钥 (CMK)                            │   │
│  │         存储在阿里云KMS，不可导出                     │   │
│  └─────────────────────┬───────────────────────────────┘   │
│                        │                                    │
│            ┌───────────┴───────────┐                       │
│            │                       │                       │
│  ┌─────────▼─────────┐  ┌─────────▼─────────┐             │
│  │   服务级数据密钥   │  │   服务级数据密钥   │             │
│  │   (Database)      │  │   (Storage)       │             │
│  └─────────┬─────────┘  └─────────┬─────────┘             │
│            │                       │                       │
│  ┌─────────▼─────────┐  ┌─────────▼─────────┐             │
│  │  用户级数据密钥    │  │  用户级数据密钥    │             │
│  │  (User A)         │  │  (User B)         │             │
│  └───────────────────┘  └───────────────────┘             │
│                                                             │
│  密钥轮换策略：                                              │
│  - CMK：每年轮换                                            │
│  - 服务级密钥：每季度轮换                                    │
│  - 用户级密钥：账户存续期（注销时销毁）                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 四、隐私分级架构（P0-P3）

> **核心设计**：针对长录音场景的隐私保护需求，采用4级隐私分类系统，确保敏感数据按照严格的安全策略处理。

### 4.1 隐私分级定义

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         隐私分级架构（P0-P3）                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  级别        敏感程度        数据类型                    处理策略            │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  ┌─────┐    ┌─────────┐    ┌─────────────────────┐    ┌─────────────────┐  │
│  │ P0  │    │ 最敏感   │    │ • 原始音频录音       │    │ 永不离开设备    │  │
│  │     │    │         │    │ • 完整转写文本       │    │ 本地加密存储    │  │
│  │     │    │         │    │ • 敏感对话内容       │    │ 本地模型处理    │  │
│  └─────┘    └─────────┘    └─────────────────────┘    └─────────────────┘  │
│                                                                             │
│  ┌─────┐    ┌─────────┐    ┌─────────────────────┐    ┌─────────────────┐  │
│  │ P1  │    │ 敏感     │    │ • 孩子真实姓名       │    │ 仅抽象摘要上云  │  │
│  │     │    │         │    │ • 出生日期          │    │ 云端存储脱敏版  │  │
│  │     │    │         │    │ • 可识别个人信息     │    │ 脱敏后调用API   │  │
│  └─────┘    └─────────┘    └─────────────────────┘    └─────────────────┘  │
│                                                                             │
│  ┌─────┐    ┌─────────┐    ┌─────────────────────┐    ┌─────────────────┐  │
│  │ P2  │    │ 中等     │    │ • AI生成的报告      │    │ 用户授权后上传  │  │
│  │     │    │         │    │ • 育儿建议          │    │ 云端加密存储    │  │
│  │     │    │         │    │ • 情绪分析结果      │    │ 可选云端同步    │  │
│  └─────┘    └─────────┘    └─────────────────────┘    └─────────────────┘  │
│                                                                             │
│  ┌─────┐    ┌─────────┐    ┌─────────────────────┐    ┌─────────────────┐  │
│  │ P3  │    │ 公开     │    │ • 匿名使用统计      │    │ 可自由同步     │  │
│  │     │    │         │    │ • 功能偏好设置      │    │ 用于产品改进    │  │
│  │     │    │         │    │ • 非敏感配置        │    │ 标准加密       │  │
│  └─────┘    └─────────┘    └─────────────────────┘    └─────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 隐私分级详细策略

| 级别 | 数据类型 | 存储位置 | 传输策略 | 加密方式 | AI处理 | 保留期限 |
|------|---------|---------|---------|---------|--------|---------|
| **P0** | 原始音频、完整转写 | 仅本地设备 | 永不上传 | 设备密钥+AES-256 | 仅本地模型 | 用户控制 |
| **P1** | 孩子姓名、生日 | 本地优先 | 仅摘要上传 | 用户密钥+服务密钥 | 脱敏后API | 账户期 |
| **P2** | AI报告、建议 | 云端加密 | 授权后上传 | 服务密钥 | 云端模型 | 用户设置 |
| **P3** | 匿名统计、偏好 | 云端 | 自动同步 | 标准TLS | 分析专用 | 90天 |

### 4.3 数据流转规则

```python
# 隐私分级处理配置
PRIVACY_CLASSIFICATION = {
    "P0": {
        "data_types": [
            "raw_audio",           # 原始录音文件
            "full_transcript",     # 完整语音转写
            "sensitive_dialogue",  # 敏感对话内容
            "biometric_data"       # 生物特征数据
        ],
        "storage": {
            "location": "device_only",
            "encryption": "device_key_aes256",
            "backup": False
        },
        "transmission": {
            "allowed": False,
            "exceptions": None
        },
        "ai_processing": {
            "model": "local_qwen2.5",
            "cloud_allowed": False
        },
        "retention": {
            "policy": "user_controlled",
            "auto_delete": False
        }
    },
    
    "P1": {
        "data_types": [
            "child_name",          # 孩子真实姓名
            "birth_date",          # 出生日期
            "phone_number",        # 手机号
            "identifiable_info"    # 其他可识别信息
        ],
        "storage": {
            "location": "local_preferred",
            "cloud_data": "abstracted_summary_only",
            "encryption": "user_key_and_server_key"
        },
        "transmission": {
            "allowed": True,
            "data_form": "anonymized_summary",
            "requires_consent": True
        },
        "ai_processing": {
            "model": "cloud_with_anonymization",
            "preprocessing": "remove_pii"
        },
        "retention": {
            "policy": "account_lifetime",
            "deletion_on_request": "72_hours"
        }
    },
    
    "P2": {
        "data_types": [
            "daily_report",        # 每日成长报告
            "weekly_summary",      # 周报月报
            "ai_suggestions",      # AI育儿建议
            "mood_analysis"        # 情绪分析结果
        ],
        "storage": {
            "location": "cloud_encrypted",
            "encryption": "server_key_aes256"
        },
        "transmission": {
            "allowed": True,
            "requires_consent": True,
            "encryption": "tls_1.3"
        },
        "ai_processing": {
            "model": "cloud_models",
            "allowed_models": ["minimax", "qwen_audio"]
        },
        "retention": {
            "policy": "user_configurable",
            "default": "365_days"
        }
    },
    
    "P3": {
        "data_types": [
            "usage_statistics",    # 使用统计
            "feature_preferences", # 功能偏好
            "app_settings",        # 应用设置
            "crash_reports"        # 崩溃报告
        ],
        "storage": {
            "location": "cloud",
            "encryption": "standard"
        },
        "transmission": {
            "allowed": True,
            "automatic": True
        },
        "ai_processing": {
            "model": "analytics_only",
            "purpose": "product_improvement"
        },
        "retention": {
            "policy": "90_days",
            "anonymization": "immediate"
        }
    }
}
```

### 4.4 隐私分级处理流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      数据隐私分级处理流程                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   数据输入                                                                   │
│      │                                                                      │
│      ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐       │
│  │                     隐私分类器 (Privacy Classifier)              │       │
│  │                                                                  │       │
│  │  输入数据 ──▶ 内容分析 ──▶ 敏感词检测 ──▶ 分级标记              │       │
│  │                                                                  │       │
│  └──────────────────────────┬──────────────────────────────────────┘       │
│                             │                                               │
│           ┌─────────────────┼─────────────────┐                            │
│           │                 │                 │                            │
│           ▼                 ▼                 ▼                            │
│     ┌──────────┐      ┌──────────┐      ┌──────────┐                      │
│     │ P0/P1    │      │ P2       │      │ P3       │                      │
│     │ 敏感数据  │      │ 中等数据  │      │ 公开数据  │                      │
│     └────┬─────┘      └────┬─────┘      └────┬─────┘                      │
│          │                 │                 │                            │
│          ▼                 ▼                 ▼                            │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                     │
│  │ 本地处理    │   │ 云端处理    │   │ 自动同步    │                     │
│  │             │   │ (需授权)    │   │             │                     │
│  │ • 本地加密  │   │ • 加密传输  │   │ • 匿名化    │                     │
│  │ • 本地模型  │   │ • 云端加密  │   │ • 聚合统计  │                     │
│  │ • 设备存储  │   │ • 审计日志  │   │             │                     │
│  └─────────────┘   └─────────────┘   └─────────────┘                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.5 敏感数据本地处理架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    P0数据本地处理架构（端侧AI）                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   毛绒硬件 / APP端                                                           │
│   ┌─────────────────────────────────────────────────────────────────┐      │
│   │                                                                  │      │
│   │   ┌─────────────┐     ┌─────────────────────────────────┐       │      │
│   │   │  麦克风输入  │────▶│      本地预处理模块              │       │      │
│   │   └─────────────┘     │                                 │       │      │
│   │                       │  • 语音活动检测 (VAD)           │       │      │
│   │                       │  • 本地降噪处理                 │       │      │
│   │                       │  • 敏感词实时检测               │       │      │
│   │                       └────────────┬────────────────────┘       │      │
│   │                                    │                            │      │
│   │                                    ▼                            │      │
│   │   ┌─────────────────────────────────────────────────────┐      │      │
│   │   │              本地AI引擎 (Qwen 2.5 Lite)              │      │      │
│   │   │                                                      │      │      │
│   │   │  • 语音转文字（端侧推理）                            │      │      │
│   │   │  • 简单问答（快速响应）                              │      │      │
│   │   │  • 敏感内容检测                                      │      │      │
│   │   │  • 隐私分级标记                                      │      │      │
│   │   └────────────────────────┬────────────────────────────┘      │      │
│   │                            │                                    │      │
│   │                            ▼                                    │      │
│   │   ┌─────────────────────────────────────────────────────┐      │      │
│   │   │              本地加密存储                            │      │      │
│   │   │                                                      │      │      │
│   │   │  ┌───────────┐  ┌───────────┐  ┌───────────┐       │      │      │
│   │   │  │ P0 原始   │  │ P1 脱敏   │  │ P2 摘要   │       │      │      │
│   │   │  │ 音频     │  │ 转写     │  │ 待同步    │       │      │      │
│   │   │  │ (AES-256)│  │ (AES-256)│  │ (队列)    │       │      │      │
│   │   │  └───────────┘  └───────────┘  └───────────┘       │      │      │
│   │   └─────────────────────────────────────────────────────┘      │      │
│   │                                                                  │      │
│   └──────────────────────────────────────────────────────────────────┘      │
│                                                                             │
│   数据永不离开设备的部分：原始音频、完整转写、敏感对话                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、TEE可信执行环境设计（后续演进）

> **说明**：TEE（Trusted Execution Environment）为后续版本规划，用于云端敏感数据处理的硬件级安全保护。

### 5.1 TEE架构设计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    TEE可信执行环境架构（V2.0规划）                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   普通执行环境 (REE)                   可信执行环境 (TEE)                     │
│   ┌─────────────────────┐             ┌─────────────────────┐              │
│   │                     │             │                     │              │
│   │   用户应用          │             │   安全应用          │              │
│   │   ┌─────────────┐   │             │   ┌─────────────┐   │              │
│   │   │ 普通AI处理  │   │             │   │ 敏感AI处理  │   │              │
│   │   │ (P2/P3数据) │   │             │   │ (P1数据)    │   │              │
│   │   └─────────────┘   │             │   └─────────────┘   │              │
│   │                     │             │                     │              │
│   │   操作系统          │    隔离     │   安全OS            │              │
│   │   (Linux/K8s)      │ ◀════════▶ │   (TrustZone)       │              │
│   │                     │             │                     │              │
│   └─────────────────────┘             └─────────────────────┘              │
│                                                                             │
│                        硬件安全模块 (HSM)                                    │
│   ┌─────────────────────────────────────────────────────────────────┐      │
│   │  • 密钥存储  • 随机数生成  • 安全启动  • 远程证明              │      │
│   └─────────────────────────────────────────────────────────────────┘      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 TEE应用场景

| 场景 | 说明 | TEE保护内容 |
|------|------|------------|
| **敏感数据解密** | P1数据需要在云端处理时 | 解密密钥、明文数据 |
| **AI模型推理** | 处理包含敏感信息的输入 | 推理过程、中间结果 |
| **数据脱敏** | 将P0/P1数据转换为P2数据 | 脱敏算法、映射关系 |
| **审计日志签名** | 生成不可篡改的审计记录 | 签名密钥、日志内容 |

### 5.3 远程证明机制（后续规划）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      远程证明流程（V2.0规划）                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   客户端                    云端TEE                      验证服务            │
│                                                                             │
│      │                         │                            │               │
│      │  1. 请求证明报告        │                            │               │
│      │ ──────────────────────▶ │                            │               │
│      │                         │                            │               │
│      │                         │  2. 生成TEE证明            │               │
│      │                         │  (硬件签名)                │               │
│      │                         │                            │               │
│      │  3. 返回证明报告        │                            │               │
│      │ ◀────────────────────── │                            │               │
│      │                         │                            │               │
│      │  4. 验证证明报告        │                            │               │
│      │ ─────────────────────────────────────────────────────▶│               │
│      │                         │                            │               │
│      │  5. 验证结果            │                            │               │
│      │ ◀─────────────────────────────────────────────────────│               │
│      │                         │                            │               │
│      │  6. 建立安全会话（验证通过后）                        │               │
│      │ ◀─────────────────────▶ │                            │               │
│                                                                             │
│   证明内容：                                                                 │
│   • TEE版本和配置                                                           │
│   • 运行代码哈希                                                            │
│   • 硬件唯一标识                                                            │
│   • 安全状态报告                                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.4 区块链验证层（V2.0规划）

> **Heima区块链集成**：后续版本将支持链上验证和审计追踪。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    区块链验证层架构（V2.0规划）                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   1. TEE生成证明报告                                                         │
│      │                                                                      │
│      ▼                                                                      │
│   2. 提交到Heima区块链                                                       │
│      │                                                                      │
│      ▼                                                                      │
│   3. 验证节点验证并存储                                                      │
│      │                                                                      │
│      ▼                                                                      │
│   4. 验证通过后释放会话密钥                                                   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────┐      │
│   │                     链上记录内容                                 │      │
│   │                                                                  │      │
│   │  • TEE证明哈希                                                  │      │
│   │  • 时间戳                                                       │      │
│   │  • 操作类型（推理/解密/脱敏）                                    │      │
│   │  • 数据访问记录（不含数据本身）                                  │      │
│   │  • 不可篡改的审计追踪                                           │      │
│   └─────────────────────────────────────────────────────────────────┘      │
│                                                                             │
│   优势：                                                                    │
│   • 可验证的AI推理过程                                                      │
│   • 不可篡改的审计日志                                                      │
│   • 用户可自主验证数据处理过程                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 六、API安全

### 4.1 API安全措施

| 措施 | 实现方式 |
|------|---------|
| 认证 | JWT Bearer Token |
| 授权 | RBAC + 资源所有权验证 |
| 限流 | 令牌桶算法，按用户/IP |
| 签名 | 敏感API请求签名 |
| 防重放 | Nonce + 时间戳 |
| 输入验证 | Pydantic模型验证 |

### 4.2 限流策略

```python
RATE_LIMITS = {
    # 按用户限流
    "user": {
        "default": "100/minute",
        "auth": "10/minute",        # 认证接口
        "record": "30/minute",      # 记录接口
        "report": "20/minute",      # 报告接口
        "ai": "10/minute",          # AI接口
    },
    # 按IP限流
    "ip": {
        "default": "1000/minute",
        "auth": "30/minute",
    }
}
```

### 4.3 敏感操作二次验证

```
┌─────────────────────────────────────────────────────────────┐
│                  敏感操作验证流程                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  敏感操作列表：                                              │
│  - 删除孩子档案                                             │
│  - 删除所有数据                                             │
│  - 导出数据                                                 │
│  - 修改手机号                                               │
│  - 注销账户                                                 │
│  - 移除家庭成员                                             │
│                                                             │
│  验证流程：                                                  │
│  1. 用户发起敏感操作请求                                     │
│  2. 检查最近一次验证时间                                     │
│     - 如果超过5分钟，要求重新验证                            │
│  3. 发送短信验证码                                          │
│  4. 用户输入验证码                                          │
│  5. 验证通过，执行操作                                       │
│  6. 记录操作日志                                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 五、审计日志

### 5.1 日志类型

| 日志类型 | 内容 | 保留期限 |
|---------|------|---------|
| 访问日志 | API调用记录 | 90天 |
| 操作日志 | 用户操作行为 | 180天 |
| 安全日志 | 登录、权限变更 | 1年 |
| 错误日志 | 系统异常 | 30天 |

### 5.2 日志格式

```json
{
  "timestamp": "2025-01-15T10:30:00.000Z",
  "level": "INFO",
  "type": "operation",
  "user_id": "user_xxx",
  "action": "create_record",
  "resource": {
    "type": "record",
    "id": "record_xxx",
    "child_id": "child_xxx"
  },
  "request": {
    "method": "POST",
    "path": "/api/v1/records",
    "ip": "xxx.xxx.xxx.xxx",
    "user_agent": "...",
    "request_id": "req_xxx"
  },
  "response": {
    "status": 200,
    "duration_ms": 150
  },
  "metadata": {
    "device_id": "device_xxx",
    "app_version": "1.0.0"
  }
}
```

### 5.3 日志脱敏

```python
# 需要脱敏的字段
MASK_FIELDS = [
    'phone',
    'password',
    'token',
    'api_key',
    'child_name',
]

def mask_sensitive_data(data: dict) -> dict:
    """
    脱敏敏感数据
    """
    for key in data:
        if key in MASK_FIELDS:
            value = data[key]
            if key == 'phone' and value:
                data[key] = value[:3] + '****' + value[-4:]
            elif key in ['password', 'token', 'api_key']:
                data[key] = '***MASKED***'
            else:
                data[key] = value[:2] + '***' if value else None
    return data
```

---

## 六、安全监控与告警

### 6.1 监控指标

| 指标 | 阈值 | 告警级别 |
|------|------|---------|
| 登录失败率 | >10%/分钟 | 警告 |
| API错误率 | >5%/分钟 | 警告 |
| 异常IP访问 | 检测到 | 严重 |
| 敏感操作频率 | >10次/小时 | 警告 |
| 数据导出请求 | 每次 | 记录 |

### 6.2 异常检测规则

```yaml
# 异常检测规则配置
rules:
  - name: brute_force_login
    description: 暴力破解登录
    condition: login_failures > 5 within 5 minutes from same IP
    action: block_ip_15min
    alert: high
    
  - name: unusual_data_access
    description: 异常数据访问模式
    condition: data_access_count > 100 within 10 minutes
    action: notify_security_team
    alert: medium
    
  - name: mass_data_export
    description: 批量数据导出
    condition: export_request from unusual_location
    action: require_2fa, notify_user
    alert: high
    
  - name: api_abuse
    description: API滥用
    condition: api_calls > rate_limit * 3
    action: block_user_1hour
    alert: medium
```

---

## 七、安全开发规范

### 7.1 代码安全检查清单

```markdown
## 代码提交前安全检查

### 认证与授权
- [ ] 所有API都需要认证（除公开接口）
- [ ] 敏感操作有权限检查
- [ ] 资源访问有所有权验证

### 输入验证
- [ ] 所有输入都经过验证
- [ ] SQL查询使用参数化
- [ ] 文件上传限制类型和大小

### 数据保护
- [ ] 敏感数据已加密
- [ ] 日志不包含敏感信息
- [ ] 错误信息不泄露实现细节

### 依赖安全
- [ ] 无已知漏洞的依赖
- [ ] 依赖版本锁定

### 配置安全
- [ ] 密钥不在代码中硬编码
- [ ] 生产环境配置安全
```

### 7.2 安全编码示例

```python
# 好的做法 ✓
@router.get("/children/{child_id}")
async def get_child(
    child_id: str,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db),
):
    # 1. 验证资源所有权
    child = await get_child_by_id(db, child_id)
    if not child:
        raise HTTPException(status_code=404)
    
    # 2. 检查用户是否有权限访问
    if not await user_can_access_child(db, current_user.id, child_id):
        raise HTTPException(status_code=403)
    
    return child

# 不好的做法 ✗
@router.get("/children/{child_id}")
async def get_child_insecure(child_id: str):
    # 没有认证
    # 没有授权检查
    # 直接返回数据
    return await get_child_by_id(child_id)
```

---

## 八、合规认证规划

### 8.1 认证路线图

| 认证 | 优先级 | 预计时间 |
|------|--------|---------|
| 等保2.0三级 | 高 | 上线前 |
| ISO 27001 | 中 | 上线后6个月 |
| SOC 2 Type I | 中 | 上线后12个月 |
| 个人信息保护认证 | 高 | 上线前 |

### 8.2 定期安全评估

| 评估类型 | 频率 | 执行方 |
|---------|------|--------|
| 漏洞扫描 | 周 | 自动化工具 |
| 渗透测试 | 季度 | 第三方安全公司 |
| 代码审计 | 季度 | 内部+外部 |
| 架构评审 | 年度 | 安全架构师 |
