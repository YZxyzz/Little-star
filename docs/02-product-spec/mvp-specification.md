# MVP产品规格说明书

> **关联文档**：
> - [APP UX设计规格](./app-ux-design.md) - 详细的用户旅程、页面清单、交互规格
> - [API接口规格](./api-specification.md) - 后端API定义
> - [硬件规格说明](../03-hardware-design/hardware-specification.md) - 毛绒硬件设计

---

## 一、MVP范围定义

### 1.1 MVP目标

**核心目标**：用最小可行产品验证以下假设

| 假设 | 验证指标 | 目标值 |
|------|---------|-------|
| 家长愿意每天记录孩子情况 | 日活跃率 | >50% |
| AI生成的报告有价值 | NPS评分 | >40 |
| 用户愿意续费订阅服务 | 续费转化率 | >50% |
| 育儿建议对家长有帮助 | 功能满意度 | >4/5分 |

> **续费率预期说明**：
> - 硬件+1年服务捆绑销售，首次付费即购买
> - 续费率指第1年服务到期后的订阅续费比例
> - 50%是及格线，优秀产品应达到60-70%

### 1.2 MVP策略

**MVP = 硬件 + 软件 完整方案**

> ⚠️ **重要更新 (2025-02-05)**：MVP必须包含硬件和软件，完整体验才能验证核心价值。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         MVP 完整产品架构                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                    🧸 毛绒硬件 (孩子端)                               │  │
│   │                                                                     │  │
│   │  核心特点：                                                          │  │
│   │  • 可爱毛绒外观 → 孩子主动愿意随身携带                                 │  │
│   │  • 48小时续航 → 2天充一次电                                          │  │
│   │  • 独立网络 → 自带蜂窝流量卡，不依赖手机                               │  │
│   │  • 持续录音 → 采集孩子身边的各种声音                                   │  │
│   │  • 按键交互 → 点击后主动对话，孩子可以问问题                           │  │
│   │                                                                     │  │
│   └───────────────────────────┬─────────────────────────────────────────┘  │
│                               │                                            │
│                               │ 实时传输音频                                │
│                               ▼                                            │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                    ☁️ 云端 AI 服务                                   │  │
│   │                                                                     │  │
│   │  处理流程：                                                          │  │
│   │  语音识别 → 对话理解 → 内容总结 → 报告生成 → 推送通知                  │  │
│   │                                                                     │  │
│   │  推送时机：                                                          │  │
│   │  • 实时：孩子有大量交谈后，立即总结推送                                │  │
│   │  • 每日：晚间生成今日完整报告                                         │  │
│   │  • 每周：周末生成本周成长趋势                                         │  │
│   │  • 每月：月底生成月度成长档案                                         │  │
│   │                                                                     │  │
│   └───────────────────────────┬─────────────────────────────────────────┘  │
│                               │                                            │
│                               │ 推送报告                                    │
│                               ▼                                            │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                    📱 父母 APP (iOS + Android)                       │  │
│   │                                                                     │  │
│   │  报告双重价值：                                                       │  │
│   │  ┌─────────────────────────┬─────────────────────────┐              │  │
│   │  │  📊 了解孩子             │  📚 教育引导             │              │  │
│   │  │  ─────────────────────  │  ─────────────────────  │              │  │
│   │  │  • 今天聊了什么话题      │  • 如何和孩子聊这件事    │              │  │
│   │  │  • 孩子的兴趣爱好        │  • 对话方式建议          │              │  │
│   │  │  • 开心/不开心的事       │  • 教育方式引导          │              │  │
│   │  │  • 好奇心问题            │  • 话题切入点建议        │              │  │
│   │  │  • 情绪状态分析          │  • 示例对话模板          │              │  │
│   │  └─────────────────────────┴─────────────────────────┘              │  │
│   │                                                                     │  │
│   │  核心价值：不仅了解孩子，更知道如何与孩子互动                           │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**MVP必须包含硬件的理由**：
1. 核心价值需要**自动采集**孩子真实对话，手动记录无法做到
2. 孩子是**主动使用者**，需要可爱的硬件来激发互动意愿
3. **48小时持续录音**才能捕捉到有价值的信息
4. 完整体验才能验证"了解孩子+教育引导"的核心价值主张

---

## 二、MVP功能清单

### 2.1 核心功能（Must Have）

#### F1: 每日记录

**功能描述**：家长每天记录孩子的情况

| 子功能 | 描述 | 优先级 |
|--------|------|--------|
| 语音记录 | 长按说话，记录今天发生的事 | P0 |
| 文字记录 | 打字输入补充信息 | P0 |
| 标签分类 | 预设标签（开心/难过/问题/进步等） | P1 |
| 时间标记 | 记录发生的时间段 | P1 |

**用户故事**：
```
作为家长，
我想要快速记录孩子今天发生的事，
以便AI能帮我生成报告和建议。
```

#### F2: 每日成长报告（v4.0 升级）

**功能描述**：AI根据孩子对话生成三层信息报告

| 子功能 | 描述 | 优先级 |
|--------|------|--------|
| 今日亮点 | 一句话叙事性总结+情感钩子 | P0 |
| 今日概要 | 30秒快速了解+历史对比数据 | P0 |
| 今日对话 | 按时间排列的对话记录和情绪 | P0 |
| 孩子的世界 | 标签页切换：心情/朋友/兴趣/困扰 | P0 |
| 值得关注 | 需要父母留意的事+场景化AI入口 | P0 |
| 今晚行动 | 具体怎么做、怎么聊+对话示例 | P0 |
| 亲子对话建议 | 个性化话题和资源推荐 | P1 |
| 家长反馈 | 评分+文字反馈+报告局限说明 | P1 |
| 渐进式披露 | 三级展开：推送/概览/完整报告 | P0 |

**用户故事**：
```
作为家长，
我想要一眼看到孩子今天的成长概要和趋势变化，
以便快速了解孩子的一天，并知道今晚该怎么和孩子聊。
```

#### F2.5: 实时推送通知（v4.0 新增）

**功能描述**：三层信息架构的第一层，即时触达家长

| 子功能 | 描述 | 优先级 |
|--------|------|--------|
| 情绪告警 | 检测到孩子哭泣/极度低落时立即推送 | P0 |
| 孩子金句 | 推送暖心/有趣/有教育意义的话 | P1 |
| 好奇心爆发 | 同一话题连续提问≥3个时推送 | P1 |
| 推送频率控制 | 每天最多5条，避免打扰 | P0 |

**用户故事**：
```
作为家长，
当孩子情绪异常或说了暖心的话时，
我希望立刻收到通知，感受到和孩子的连接。
```

#### F3: 育儿建议

**功能描述**：AI针对具体事件给出沟通/教育建议

| 子功能 | 描述 | 优先级 |
|--------|------|--------|
| 事件建议 | 针对特定事件的沟通建议 | P0 |
| 对话模板 | 建议的对话开场白 | P1 |
| 知识科普 | 相关儿童心理/教育知识 | P2 |

**用户故事**：
```
作为家长，
当我记录了孩子和小朋友吵架的事，
我希望AI告诉我怎么和孩子聊这件事。
```

#### F4: 成长档案

**功能描述**：查看历史记录和长期趋势

| 子功能 | 描述 | 优先级 |
|--------|------|--------|
| 历史日报 | 查看过去的每日报告 | P0 |
| 周/月总结 | 周度/月度成长回顾 | P1 |
| 搜索查询 | 搜索特定事件/话题 | P2 |

### 2.2 辅助功能（Should Have）

#### F5: 问问AI

**功能描述**：家长随时向AI提问育儿问题

| 子功能 | 描述 | 优先级 |
|--------|------|--------|
| 通用问答 | 回答育儿相关问题 | P1 |
| 情境问答 | 结合孩子档案的个性化回答 | P2 |

#### F6: 家庭成员

**功能描述**：支持多人共同记录

| 子功能 | 描述 | 优先级 |
|--------|------|--------|
| 邀请家人 | 邀请爸爸/妈妈/祖父母 | P1 |
| 权限管理 | 设置不同角色权限 | P2 |

### 2.3 延后功能（Won't Have in MVP）

> 详细的MVP APP功能范围请参考 [APP UX设计规格](./app-ux-design.md)

| 功能 | 延后原因 | 预计版本 |
|------|---------|---------|
| 家庭共享（多用户协作） | 多用户协作复杂度高 | V1.1 |
| 历史搜索/筛选 | 非核心验证功能 | V1.1 |
| 数据导出 | 运营优先级低 | V1.2 |
| 月报 | 需要足够数据积累 | V1.1 |
| 语音/视频通话 | 非核心价值 | V2.0 |
| 社区功能 | 与核心价值无关 | V2.0 |

---

## 三、技术选型

> ⚠️ **技术架构更新 (2025-02-05)**：采用多模型编排架构，智能路由不同任务到最优模型，同时引入隐私分级机制保护长录音数据安全。

### 3.1 技术架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           系统架构图（多模型编排）                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────┐   ┌──────────────────────┐   ┌──────────────────────┐    │
│  │ 毛绒硬件  │   │  React Native APP    │   │      Web管理后台      │    │
│  │ (孩子端) │   │  (iOS + Android)     │   │                      │    │
│  └────┬─────┘   └──────────┬───────────┘   └──────────┬───────────┘    │
│       │              │              │                     │               │
│       └──────────────┴──────────────┴─────────────────────┘               │
│                                     │                                      │
│                                     ▼                                      │
│                          ┌─────────────────┐                               │
│                          │   API Gateway    │                               │
│                          │   (Kong/Nginx)   │                               │
│                          └────────┬────────┘                               │
│                                   │                                        │
│       ┌───────────────────────────┼───────────────────────────┐            │
│       ▼                           ▼                           ▼            │
│  ┌─────────┐              ┌─────────────────┐          ┌─────────────┐    │
│  │用户服务  │              │   智能路由层     │          │  记录服务    │    │
│  │(Node.js)│              │ (Model Router)  │          │  (Node.js)  │    │
│  └────┬────┘              └────────┬────────┘          └──────┬──────┘    │
│       │                            │                          │           │
│       │         ┌──────────────────┼──────────────────┐       │           │
│       │         ▼                  ▼                  ▼       │           │
│       │   ┌──────────┐      ┌──────────┐       ┌──────────┐   │           │
│       │   │ 语音模型  │      │ 推理模型  │       │ 本地模型  │   │           │
│       │   │(Whisper) │      │(MiniMax) │       │(Qwen2.5) │   │           │
│       │   └──────────┘      └──────────┘       └──────────┘   │           │
│       │                            │                          │           │
│       ▼                            ▼                          ▼           │
│  ┌─────────────────────────────────────────────────────────────────┐      │
│  │                    数据存储层                                     │      │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │      │
│  │  │ PostgreSQL  │  │   Milvus    │  │   Neo4j     │              │      │
│  │  │ (业务数据)  │  │ (向量索引)   │  │ (关系图谱)  │              │      │
│  │  └─────────────┘  └─────────────┘  └─────────────┘              │      │
│  └─────────────────────────────────────────────────────────────────┘      │
│                                   │                                        │
│                                   ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────┐      │
│  │               辅助服务层                                          │      │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐      │      │
│  │  │    Redis    │  │  阿里云OSS   │  │  隐私分级处理器      │      │      │
│  │  │ (缓存/队列) │  │ (文件存储)  │  │  (P0-P3分类)        │      │      │
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘      │      │
│  └─────────────────────────────────────────────────────────────────┘      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 多模型编排架构

> **核心理念**：不依赖单一AI模型，而是智能路由任务到最优模型组合，提升处理效率和质量。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         多模型智能编排                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   输入类型                    智能路由                      处理模型          │
│                                                                             │
│  ┌─────────┐                                          ┌─────────────────┐  │
│  │ 语音输入 │ ─────────────────────────────────────▶  │ Qwen Audio      │  │
│  │ (录音)  │                                          │ / Whisper       │  │
│  └─────────┘                                          │ 语音识别        │  │
│                                                       └────────┬────────┘  │
│  ┌─────────┐              ┌─────────────┐                      │           │
│  │ 图像输入 │ ──────────▶ │             │             ┌────────▼────────┐  │
│  │(截图/照片)│             │  智能路由器  │ ─────────▶ │ Kimi 2.5        │  │
│  └─────────┘              │             │             │ 视觉理解/OCR    │  │
│                           │  分析输入   │             └────────┬────────┘  │
│  ┌─────────┐              │  类型和     │                      │           │
│  │ 文本输入 │ ──────────▶ │  复杂度     │             ┌────────▼────────┐  │
│  │(家长记录)│              │             │ ─────────▶ │ MiniMax         │  │
│  └─────────┘              │  路由到     │             │ 深度推理/报告   │  │
│                           │  最优模型   │             └────────┬────────┘  │
│  ┌─────────┐              │             │                      │           │
│  │ 简单查询 │ ──────────▶ │             │             ┌────────▼────────┐  │
│  │(快速问答)│              └─────────────┘ ─────────▶ │ Qwen 2.5 本地   │  │
│  └─────────┘                                          │ 快速响应/隐私   │  │
│                                                       └─────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 模型选型详情

| 模型 | 主要用途 | 选型 | 备选 |
|------|---------|------|------|
| **语音识别** | 录音转文字、说话人分离 | **Qwen Audio** | Whisper, 阿里云语音识别, 讯飞 |
| **视觉理解** | 图片理解、文档OCR、截图分析 | **Kimi 2.5** | GPT-4V |
| **深度推理** | 复杂分析、报告生成、洞察提取 | **MiniMax** | 通义千问(qwen-max), Claude |
| **快速查询** | 简单问答、关键词搜索、隐私优先 | **Qwen 2.5 (本地/云端)** | DeepSeek |
| **向量嵌入** | 语义索引、相似度搜索 | **BGE / Jina** | text-embedding-ada |
| **向量数据库** | 向量检索、语义搜索 | **Milvus** | PostgreSQL + pgvector |
| **图数据库** | 关系图谱、知识关联 | **Neo4j** | - |

**模型选型理由**：
1. **Qwen Audio**：中文语音识别准确率高，支持长音频和说话人分离
2. **Kimi 2.5**：视觉理解能力强，支持文档解析和手写识别
3. **MiniMax**：长上下文支持好，推理能力强，适合生成深度报告
4. **Qwen 2.5 本地**：可本地部署，简单查询零延迟且数据不出设备
5. **BGE/Jina**：中文嵌入效果好，支持多模态检索

### 3.3 数据处理管道

> **5阶段处理流程**：从原始输入到可检索的个人记忆

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    数据处理管道（5阶段）                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ① 摄入          ② 提取           ③ 蒸馏          ④ 索引         ⑤ 推理     │
│  INGESTION      EXTRACTION       DISTILLATION     INDEXING      INFERENCE  │
│                                                                             │
│  ┌─────────┐    ┌─────────┐     ┌─────────┐     ┌─────────┐    ┌─────────┐ │
│  │多源采集  │───▶│智能提取  │────▶│记忆蒸馏  │────▶│多维索引  │───▶│安全推理  │ │
│  └─────────┘    └─────────┘     └─────────┘     └─────────┘    └─────────┘ │
│       │              │               │               │              │       │
│       ▼              ▼               ▼               ▼              ▼       │
│  ┌─────────┐    ┌─────────┐     ┌─────────┐     ┌─────────┐    ┌─────────┐ │
│  │• 语音    │    │• 实体识别│     │• 情景记忆│     │• 向量索引│    │• 隐私分级│ │
│  │• 文字    │    │• 承诺检测│     │• 语义记忆│     │• 关键词  │    │• 查询优化│ │
│  │• 图片    │    │• 话题分类│     │• 任务记忆│     │• 图索引  │    │• 结果生成│ │
│  └─────────┘    └─────────┘     └─────────┘     └─────────┘    └─────────┘ │
│       │              │               │               │              │       │
│   使用模型        使用模型         使用模型         使用工具        隐私控制   │
│  ┌─────────┐    ┌─────────┐     ┌─────────┐     ┌─────────┐    ┌─────────┐ │
│  │Whisper  │    │MiniMax  │     │BGE      │     │Milvus   │    │P0-P3    │ │
│  │Kimi 2.5 │    │Qwen 2.5 │     │Local LLM│     │Neo4j    │    │分级处理  │ │
│  └─────────┘    └─────────┘     └─────────┘     └─────────┘    └─────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 各阶段详细说明

| 阶段 | 功能 | 处理内容 | 技术选型 |
|------|------|---------|---------|
| **① 摄入** | 多源数据采集 | 语音(持续录音)、文字(家长输入)、图片(可选) | Qwen Audio, Kimi 2.5 |
| **② 提取** | 结构化信息抽取 | 实体识别、承诺检测、话题分类、情绪识别 | MiniMax, Qwen 2.5 |
| **③ 蒸馏** | 压缩为记忆单元 | 情景记忆(事件)、语义记忆(知识)、任务记忆(待办) | BGE Embed, Local LLM |
| **④ 索引** | 构建检索索引 | 向量索引(语义)、关键词索引(精确)、图索引(关系) | Milvus, PostgreSQL, Neo4j |
| **⑤ 推理** | 安全查询与生成 | 隐私分级过滤、查询优化、报告生成 | 隐私分级处理器 |

### 3.4 隐私分级架构（P0-P3）

> **重要**：长录音场景下数据安全至关重要，采用4级隐私分类确保数据安全。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         隐私分级处理架构                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   原始数据                  隐私分级                     处理策略             │
│                                                                             │
│  ┌─────────────┐     ┌─────────────────┐                                   │
│  │  语音录音    │────▶│   P0 - 最敏感    │────▶ 永不离开设备                  │
│  │  (原始音频)  │     │   原始音频       │     本地加密存储，本地模型处理      │
│  └─────────────┘     └─────────────────┘                                   │
│                                                                             │
│  ┌─────────────┐     ┌─────────────────┐                                   │
│  │  孩子档案    │────▶│   P1 - 敏感      │────▶ 仅抽象摘要上云                │
│  │  (姓名/生日) │     │   可识别信息     │     云端仅存储脱敏后的摘要信息      │
│  └─────────────┘     └─────────────────┘                                   │
│                                                                             │
│  ┌─────────────┐     ┌─────────────────┐                                   │
│  │  AI分析结果  │────▶│   P2 - 中等      │────▶ 部分内容可上云                │
│  │  (报告/建议) │     │   分析结果       │     经用户同意后可同步云端          │
│  └─────────────┘     └─────────────────┘                                   │
│                                                                             │
│  ┌─────────────┐     ┌─────────────────┐                                   │
│  │  使用统计    │────▶│   P3 - 公开      │────▶ 可自由同步                    │
│  │  (匿名数据)  │     │   非敏感信息     │     用于产品改进的匿名统计          │
│  └─────────────┘     └─────────────────┘                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 隐私分级策略

| 级别 | 数据类型 | 存储位置 | 传输策略 | AI处理方式 |
|------|---------|---------|---------|-----------|
| **P0** | 原始音频、完整转写文本 | 仅本地设备 | 永不上传 | 本地模型处理(Qwen 2.5本地) |
| **P1** | 孩子姓名、生日、敏感对话 | 本地优先，云端加密 | 仅摘要上传 | 脱敏后调用云端API |
| **P2** | AI报告、育儿建议 | 云端加密存储 | 用户授权后上传 | 云端模型处理 |
| **P3** | 匿名使用统计、功能偏好 | 云端 | 自动同步 | 用于产品分析 |

#### 数据流转规则

```python
# 隐私分级处理示例
PRIVACY_LEVELS = {
    "P0": {
        "data_types": ["raw_audio", "full_transcript"],
        "storage": "local_only",
        "encryption": "device_key",
        "ai_model": "local_qwen2.5",
        "retention": "user_controlled"
    },
    "P1": {
        "data_types": ["child_name", "birth_date", "sensitive_content"],
        "storage": "local_preferred",
        "cloud_data": "abstracted_summary_only",
        "encryption": "user_key + server_key",
        "ai_model": "cloud_with_anonymization"
    },
    "P2": {
        "data_types": ["daily_report", "suggestions", "mood_analysis"],
        "storage": "cloud_encrypted",
        "encryption": "server_key",
        "ai_model": "cloud_models"
    },
    "P3": {
        "data_types": ["usage_stats", "feature_preferences"],
        "storage": "cloud",
        "encryption": "standard",
        "ai_model": "analytics_only"
    }
}
```

### 3.5 技术栈选择

#### 前端

| 层面 | 选型 | 理由 |
|------|------|------|
| 父母端APP | React Native | 跨平台（iOS + Android），推送通知支持好 |
| 管理后台 | React + Ant Design | 成熟生态，开发效率高 |

> **为什么不做微信小程序**：
> - 推送通知受限，无法及时触达用户
> - 入口太深，用户打开路径长
> - 后台运行受限，无法保持实时连接

#### 后端

| 层面 | 选型 | 理由 |
|------|------|------|
| API服务 | Node.js (NestJS) | TypeScript支持，开发效率高 |
| AI服务 | Python (FastAPI) | AI生态成熟，模型对接便捷 |
| 智能路由 | Python (LangChain) | 多模型编排能力强 |
| 业务数据库 | PostgreSQL | 可靠性高，支持JSON |
| 向量数据库 | **Milvus** | 高性能向量检索，支持亿级数据 |
| 图数据库 | **Neo4j** | 关系建模，支持复杂查询 |
| 缓存 | Redis | 高性能，支持队列 |
| 存储 | 阿里云OSS | 国内合规，成本可控 |

#### AI能力

| 能力 | 主选 | 备选 | 适用场景 |
|------|------|------|---------|
| 语音识别 | **Qwen Audio** | Whisper, 阿里云语音 | 长录音转写、说话人分离 |
| 视觉理解 | **Kimi 2.5** | GPT-4V | 图片理解、文档OCR |
| 深度推理 | **MiniMax** | 通义千问(qwen-max), Claude | 报告生成、洞察提取 |
| 快速查询 | **Qwen 2.5** | DeepSeek | 简单问答、本地处理 |
| 向量嵌入 | **BGE / Jina** | text-embedding-ada | 语义索引、相似搜索 |

### 3.6 核心模块设计

#### 语音处理流程（含隐私分级）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    语音处理流程（隐私优先）                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  硬件持续录音                                                                │
│       │                                                                     │
│       ▼                                                                     │
│  ┌─────────────────────────────────────────┐                               │
│  │  本地预处理（设备端）                     │                               │
│  │  • 语音活动检测（VAD）                   │                               │
│  │  • 本地语音识别（Qwen 2.5 本地版）        │                               │
│  │  • 隐私敏感词检测                        │                               │
│  │  • P0数据本地加密存储                    │                               │
│  └────────────────────┬────────────────────┘                               │
│                       │                                                     │
│                       ▼                                                     │
│  ┌─────────────────────────────────────────┐                               │
│  │  隐私分级判断                            │                               │
│  │  • P0: 原始音频 → 保留本地               │                               │
│  │  • P1: 敏感内容 → 脱敏后上传摘要          │                               │
│  │  • P2: 普通内容 → 可选上传云端处理        │                               │
│  └────────────────────┬────────────────────┘                               │
│                       │                                                     │
│       ┌───────────────┴───────────────┐                                    │
│       ▼                               ▼                                    │
│  ┌─────────────┐              ┌─────────────┐                              │
│  │ 本地处理    │              │ 云端处理    │                              │
│  │ (P0/P1)    │              │ (P2/P3)    │                              │
│  │             │              │             │                              │
│  │ Qwen 2.5   │              │ Qwen Audio  │                              │
│  │ 本地推理    │              │ 云端识别    │                              │
│  └──────┬──────┘              └──────┬──────┘                              │
│         │                            │                                     │
│         └────────────┬───────────────┘                                     │
│                      ▼                                                     │
│             ┌─────────────────┐                                            │
│             │  信息提取与蒸馏  │                                            │
│             │  MiniMax 推理   │                                            │
│             └────────┬────────┘                                            │
│                      ▼                                                     │
│             ┌─────────────────┐                                            │
│             │  索引与存储      │                                            │
│             │  Milvus + Neo4j │                                            │
│             └────────┬────────┘                                            │
│                      ▼                                                     │
│             ┌─────────────────┐                                            │
│             │  报告生成推送    │                                            │
│             └─────────────────┘                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 报告生成流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    报告生成流程（多模型协作）                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  触发条件：                                                                  │
│  • 实时推送：孩子有大量对话后立即总结                                          │
│  • 每日报告：晚间8点生成今日完整报告                                           │
│  • 周报/月报：周末/月底生成成长趋势                                            │
│                                                                             │
│       │                                                                     │
│       ▼                                                                     │
│  ┌─────────────────────────────────────────┐                               │
│  │  数据聚合                                │                               │
│  │  • 从Milvus检索相关记忆向量              │                               │
│  │  • 从Neo4j获取话题关系图                 │                               │
│  │  • 从PostgreSQL获取历史档案摘要          │                               │
│  └────────────────────┬────────────────────┘                               │
│                       │                                                     │
│                       ▼                                                     │
│  ┌─────────────────────────────────────────┐                               │
│  │  多模型协作生成                          │                               │
│  │                                         │                               │
│  │  MiniMax (主力)                         │                               │
│  │  ├── 深度分析孩子行为模式                │                               │
│  │  ├── 提取关键成长事件                   │                               │
│  │  ├── 生成情绪分析和趋势                 │                               │
│  │  └── 输出结构化JSON报告                 │                               │
│  │                                         │                               │
│  │  Qwen 2.5 (辅助)                        │                               │
│  │  └── 快速生成对话建议模板               │                               │
│  └────────────────────┬────────────────────┘                               │
│                       │                                                     │
│                       ▼                                                     │
│  ┌─────────────────────────────────────────┐                               │
│  │  隐私审核 & 推送                         │                               │
│  │  • 检查报告是否包含P0/P1数据             │                               │
│  │  • 脱敏处理敏感内容                      │                               │
│  │  • 推送通知给父母APP                     │                               │
│  └─────────────────────────────────────────┘                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.7 后续演进规划

| 阶段 | 技术能力 | 说明 |
|------|---------|------|
| **MVP** | 多模型编排 + 隐私分级 | 当前版本，专注数据安全 |
| **V1.1** | TEE可信执行环境 | 云端敏感数据处理时使用TEE保护 |
| **V2.0** | Heima区块链验证 | 添加链上审计追踪，可验证AI推理 |

---

## 四、数据模型

### 4.1 核心实体

```sql
-- 用户表
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    phone VARCHAR(20) UNIQUE NOT NULL,
    nickname VARCHAR(50),
    avatar_url VARCHAR(255),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 孩子档案表
CREATE TABLE children (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    name VARCHAR(50) NOT NULL,
    nickname VARCHAR(50),
    gender VARCHAR(10),
    birth_date DATE,
    avatar_url VARCHAR(255),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 记录表
CREATE TABLE records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    child_id UUID REFERENCES children(id),
    user_id UUID REFERENCES users(id),  -- 记录人
    content_type VARCHAR(20) NOT NULL,  -- 'audio', 'text'
    audio_url VARCHAR(255),
    transcript TEXT,
    tags VARCHAR(50)[],
    event_time TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 每日报告表（v4.0 升级）
CREATE TABLE daily_reports (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    child_id UUID REFERENCES children(id),
    report_date DATE NOT NULL,
    highlight TEXT,  -- v4.0: 今日亮点叙事
    summary TEXT,
    key_events JSONB,
    mood_analysis JSONB,
    mood_stability_score INTEGER,  -- v4.0: 本周情绪稳定度评分
    topics VARCHAR(100)[],
    suggestions JSONB,
    world_data JSONB,  -- v4.0: 孩子的世界（心情/朋友/兴趣/困扰）
    attention_items JSONB,  -- v4.0: 值得关注
    action_guide JSONB,  -- v4.0: 今晚行动
    chat_suggestions JSONB,  -- v4.0: 亲子对话建议
    personalized_resources JSONB,  -- v4.0: 个性化资源推荐
    conversation_count INTEGER DEFAULT 0,  -- v4.0: 当日对话次数
    comparison_data JSONB,  -- v4.0: 历史对比数据
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(child_id, report_date)
);

-- 周/月报告表
CREATE TABLE period_reports (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    child_id UUID REFERENCES children(id),
    period_type VARCHAR(10) NOT NULL,  -- 'weekly', 'monthly'
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    summary TEXT,
    highlights JSONB,
    growth_metrics JSONB,
    recommendations JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 家庭成员表
CREATE TABLE family_members (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    child_id UUID REFERENCES children(id),
    user_id UUID REFERENCES users(id),
    role VARCHAR(20) NOT NULL,  -- 'parent', 'grandparent', 'other'
    relationship VARCHAR(20),   -- 'father', 'mother', 'grandmother', etc.
    permissions JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(child_id, user_id)
);

-- 实时推送记录表（v4.0 新增）
CREATE TABLE realtime_pushes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    child_id UUID REFERENCES children(id),
    user_id UUID REFERENCES users(id),
    push_type VARCHAR(20) NOT NULL,  -- 'emotion_alert', 'golden_quote', 'curiosity_burst'
    title VARCHAR(100) NOT NULL,
    content TEXT NOT NULL,
    child_quote TEXT,  -- 孩子原话
    mood_tag VARCHAR(20),
    conversation_time TIMESTAMP,
    is_read BOOLEAN DEFAULT FALSE,
    is_favorited BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 成长收藏夹表（v4.0 新增）
CREATE TABLE growth_favorites (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    child_id UUID REFERENCES children(id),
    user_id UUID REFERENCES users(id),
    favorite_type VARCHAR(20) NOT NULL,  -- 'golden_quote', 'event', 'milestone'
    source_type VARCHAR(20),  -- 'daily_report', 'realtime_push', 'milestone'
    source_id UUID,  -- 关联的报告/推送/里程碑ID
    title VARCHAR(200),
    content TEXT,
    child_quote TEXT,
    parent_note TEXT,  -- 家长备注
    event_date DATE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 成长里程碑表（v4.0 新增）
CREATE TABLE growth_milestones (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    child_id UUID REFERENCES children(id),
    milestone_type VARCHAR(30) NOT NULL,  -- 'cognitive', 'emotional', 'social', 'interest'
    title VARCHAR(200) NOT NULL,
    description TEXT,
    child_quote TEXT,  -- 触发里程碑的孩子原话
    psychology_insight TEXT,  -- 发展心理学解读
    parent_suggestion TEXT,  -- 父母可以做什么
    discovered_at TIMESTAMP DEFAULT NOW(),
    is_confirmed BOOLEAN DEFAULT FALSE,  -- 家长确认
    created_at TIMESTAMP DEFAULT NOW()
);

-- 家长反馈表（v4.0 新增）
CREATE TABLE parent_feedback (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    report_id UUID REFERENCES daily_reports(id),
    user_id UUID REFERENCES users(id),
    rating VARCHAR(10) NOT NULL,  -- 'helpful', 'neutral', 'not_helpful'
    feedback_text TEXT,
    action_result TEXT,  -- 今晚和孩子聊的结果
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 4.2 索引设计

```sql
-- 性能优化索引
CREATE INDEX idx_records_child_created ON records(child_id, created_at DESC);
CREATE INDEX idx_daily_reports_child_date ON daily_reports(child_id, report_date DESC);
CREATE INDEX idx_records_tags ON records USING GIN(tags);

-- v4.0 新增索引
CREATE INDEX idx_realtime_pushes_child ON realtime_pushes(child_id, created_at DESC);
CREATE INDEX idx_realtime_pushes_unread ON realtime_pushes(user_id, is_read) WHERE is_read = FALSE;
CREATE INDEX idx_growth_favorites_child ON growth_favorites(child_id, created_at DESC);
CREATE INDEX idx_growth_milestones_child ON growth_milestones(child_id, discovered_at DESC);
CREATE INDEX idx_parent_feedback_report ON parent_feedback(report_id);
```

---

## 五、AI Prompt设计

### 5.1 每日报告生成Prompt（v4.0）

```
你是一个儿童心理专家和育儿顾问。

以下是孩子今天和小星伴的对话记录（包含时间戳和内容）。
请基于这些对话生成一份每日成长报告。

## 孩子信息
- 姓名：{child_name}
- 年龄：{age}岁
- 昵称：{nickname}

## 今日对话记录
{conversations}

## 历史数据
{history_stats}

## 重要原则
- 只基于孩子说的内容来分析，不要假设孩子没说的事情
- 情绪分析基于每次对话，不要画连续曲线
- 所有信息都要标注"孩子说"，让父母知道数据来源
- 引用孩子的原话，让父母"听到"孩子的声音
- 与昨天和本周平均数据对比，展示趋势
- 资源推荐必须基于孩子今天的具体对话内容，不要给通用推荐

## 输出要求
请以JSON格式输出，包含以下字段：

{
  "highlight": "3-4行叙事性总结+一句话提炼",
  "overview": {
    "conversation_count": "今日对话次数",
    "shared_events": "主动分享的事件数",
    "questions_asked": "提出的问题数",
    "comparison": {
      "vs_yesterday": "与昨天的对比",
      "vs_week_avg": "与本周平均的对比"
    }
  },
  "conversations": [
    {
      "time": "对话时间",
      "mood": "情绪标签",
      "quotes": ["孩子的原话"],
      "summary": "这段对话的摘要"
    }
  ],
  "world": {
    "mood_timeline": "情绪时间线",
    "people_mentioned": ["提到的人及关系"],
    "interests": ["感兴趣的话题及热度"],
    "concerns": ["可能的困扰"]
  },
  "attention_items": [
    {
      "title": "关注事项",
      "quotes": ["相关原话"],
      "analysis": "分析",
      "ai_entry_prompt": "推荐的AI咨询入口提示"
    }
  ],
  "action_guide": {
    "steps": ["分步骤的行动建议"],
    "dialogue_examples": ["对话示例"],
    "dont_do": ["不要这样做"],
    "do_this": ["建议这样做"]
  },
  "chat_suggestions": {
    "topics": ["推荐话题"],
    "resources": ["个性化资源推荐（基于今日对话）"],
    "checklist": ["今晚对话清单"]
  },
  "report_meta": {
    "conversation_count": "基于几次对话",
    "disclaimer": "报告局限说明"
  }
}

## 语言风格
温暖、专业、不说教
```

### 5.2 育儿问答Prompt

```
你是一位专业的育儿顾问，专注于3-7岁学龄前儿童的教育和发展。

## 孩子档案
- 姓名：{child_name}
- 年龄：{age}岁
- 近期关注点：{recent_topics}
- 近期事件：{recent_events}

## 家长问题
{question}

## 回答要求
1. 回答要简洁实用，300字以内
2. 结合孩子的具体情况给建议
3. 给出具体可执行的行动建议
4. 如果涉及心理问题，建议专业咨询
5. 语气温和、不评判
```

### 5.3 实时推送触发Prompt（v4.0 新增）

```
你是一个儿童心理分析专家。

分析以下刚刚发生的孩子对话片段，判断是否需要即时推送通知给家长。

推送类型判断：
1. 情绪告警：孩子表达了强烈的负面情绪（难过、害怕、愤怒）且持续时间超过2分钟
2. 孩子金句：孩子说了一句特别暖心、有趣、有教育意义的话
3. 好奇心爆发：孩子在同一话题连续提问3个以上问题

如果判断需要推送，输出JSON：
{
  "should_push": true,
  "push_type": "emotion_alert|golden_quote|curiosity_burst",
  "title": "推送标题（10字以内）",
  "content": "推送内容（引用孩子原话，30字以内）",
  "mood_tag": "情绪标签",
  "urgency": "high|medium|low"
}

如果不需要推送：
{
  "should_push": false,
  "reason": "不需要推送的原因"
}
```

---

## 六、开发计划

### 6.1 里程碑

| 里程碑 | 目标 | 交付物 |
|--------|------|--------|
| M1: 技术验证 | 验证核心技术可行性 | Demo原型 |
| M2: MVP Alpha | 核心功能可用 | 内测版本 |
| M3: MVP Beta | 功能完善，准备测试 | 公测版本 |
| M4: MVP Launch | 正式上线 | 1.0版本 |

### 6.2 M1: 技术验证（2周）

**目标**：验证语音识别和报告生成的可行性

| 任务 | 负责人 | 工时 |
|------|--------|------|
| 搭建基础后端框架 | 后端 | 3天 |
| 对接阿里云语音识别 | 后端 | 2天 |
| 对接通义千问API | 后端 | 2天 |
| Prompt调优测试 | AI | 3天 |
| 简单前端Demo | 前端 | 2天 |

**验收标准**：
- 语音转文字准确率 > 90%
- 报告生成质量符合预期
- 单次生成时间 < 10秒

### 6.3 M2: MVP Alpha（4周）

**目标**：核心功能可用，内部可测试

| 模块 | 功能 | 工时 |
|------|------|------|
| 用户模块 | 注册登录、手机验证 | 3天 |
| 孩子模块 | 创建/编辑孩子档案 | 2天 |
| 记录模块 | 语音/文字记录 | 5天 |
| 报告模块 | 每日报告生成和展示 | 5天 |
| 建议模块 | 育儿建议生成 | 3天 |
| APP开发 | React Native完整UI开发 | 10天 |

### 6.4 M3: MVP Beta（2周）

**目标**：功能完善，准备用户测试

| 任务 | 描述 | 工时 |
|------|------|------|
| Bug修复 | Alpha测试问题修复 | 3天 |
| 性能优化 | 接口响应时间优化 | 2天 |
| 体验优化 | UI/UX细节打磨 | 3天 |
| 数据统计 | 埋点和数据分析 | 2天 |
| 运营后台 | 基础管理功能 | 2天 |

### 6.5 M4: MVP Launch（2周）

**目标**：正式上线，开始用户测试

| 任务 | 描述 | 工时 |
|------|------|------|
| 安全审计 | 安全漏洞检查 | 2天 |
| 压力测试 | 并发性能测试 | 2天 |
| 合规检查 | 隐私政策、用户协议 | 2天 |
| 上线部署 | 生产环境部署 | 2天 |
| 监控告警 | 系统监控配置 | 2天 |

---

## 七、资源需求

### 7.1 团队配置

| 角色 | 人数 | 职责 |
|------|------|------|
| 产品经理 | 1 | 需求管理、用户调研 |
| 后端工程师 | 2 | API开发、AI对接 |
| 前端工程师 | 1-2 | React Native APP开发 |
| UI设计师 | 1 | 界面设计 |
| 测试工程师 | 1 | 质量保证 |

### 7.2 云服务预算（月）

| 服务 | 规格 | 费用/月 |
|------|------|--------|
| ECS服务器 | 2核4G × 2 | ¥400 |
| RDS数据库 | 2核4G | ¥300 |
| Redis | 1G | ¥100 |
| OSS存储 | 100G | ¥50 |
| 语音识别 | 10万次 | ¥500 |
| 通义千问 | 100万Token | ¥200 |
| **合计** | | **¥1,550** |

### 7.3 第三方服务

| 服务 | 用途 | 费用 |
|------|------|------|
| 短信服务 | 验证码 | ¥0.04/条 |
| 微信支付 | 收款 | 0.6%费率 |
| 阿里云CDN | 静态资源 | 按量付费 |

---

## 八、风险与应对

| 风险 | 可能性 | 影响 | 应对措施 |
|------|--------|------|---------|
| AI生成质量不稳定 | 中 | 高 | 多模型对比、人工审核兜底 |
| 语音识别准确率低 | 低 | 中 | 选择行业领先服务商 |
| 用户记录意愿低 | 中 | 高 | 简化记录流程、激励机制 |
| 隐私合规问题 | 中 | 高 | 提前法务审核、隐私设计 |
| 开发进度延期 | 中 | 中 | 预留buffer、核心功能优先 |
